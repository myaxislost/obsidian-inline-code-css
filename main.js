"use strict";const d=require("obsidian"),g=require("@codemirror/view"),E=require("@codemirror/state");function h(i){const t=i.indexOf(":");return t===-1?null:{left:i.slice(0,t),right:i.slice(t+1)}}function x(i){const t=[];for(const e of i){if(typeof e!="string")continue;const s=e.trim();if(!s)continue;const n=h(s);if(!n)continue;const r=n.left.trim(),a=n.right.trim();!r||!a||t.push({prefix:`${r}:`,clsName:a})}return t}function C(i,t){if(typeof i!="string")return null;const e=i.trim();if(!e)return null;const s=h(e);if(!s)return null;const n=s.left.trim(),r=s.right.trim();if(!n||!r)return null;const a=`${n}:`;if(a===":")return null;const c=[];for(const{prefix:u,clsName:o}of t)a===u&&c.push(o);return c.length===0?null:{prefix:n,clsNames:c,value:r}}function S(i){if(typeof i!="string")return!1;const t=i.trim();if(!t)return!1;const e=h(t);if(!e)return!1;const s=e.left.trim(),n=e.right.trim();return s.length>0&&n.length>0}function T(i){if(!Array.isArray(i))return[];const t=[];for(const e of i){if(!S(e))continue;const s=h(e.trim());s&&t.push(`${s.left.trim()}:${s.right.trim()}`)}return t}const P={prefixClass:["<:dialogue-left",">:dialogue-right"]};function L(i){const t={...P};return!i||typeof i!="object"?t:{prefixClass:T(i.prefixClass)}}class N extends d.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){const{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Inline prefix → CSS class"});const e=this.plugin.settings.prefixClass;if(new d.Setting(t).setName("Add mapping").setDesc("Adds a new prefix → class mapping. Styling is done in your CSS snippets.").addButton(s=>{s.setCta(),s.setButtonText("Add"),s.onClick(async()=>{this.plugin.settings.prefixClass.push("<:example-class"),await this.plugin.saveSettings(),this.display()})}).addButton(s=>{s.setButtonText("Save"),s.onClick(async()=>{await this.plugin.saveSettings(),this.display()})}),e.length===0){t.createEl("p",{text:"No mappings yet. Click Add to create one."});return}for(let s=0;s<e.length;s++){const n=e[s]??"",r=h(n)??{left:n,right:""};let a=r.left,c=r.right;const u=new d.Setting(t).setName("Mapping");u.addText(o=>{o.setPlaceholder("prefix"),o.setValue(a),o.onChange(async l=>{l.length!==0&&(a=l,e[s]=`${a}:${c}`)})}),u.addText(o=>{o.setPlaceholder("class"),o.setValue(c),o.onChange(async l=>{l.length!==0&&(c=l,e[s]=`${a}:${c}`)})}),u.addButton(o=>{o.setWarning(),o.setButtonText("Remove"),o.onClick(async()=>{e.splice(s,1),await this.plugin.saveSettings(),this.display()})}),u.setDesc("enter prefix:class-name separated by :")}}}function A(i,t){i.registerMarkdownPostProcessor(e=>{const n=t()?.prefixClass??[],r=x(n);if(r.length===0)return;const a=Array.from(e.querySelectorAll("code"));for(const c of a){if(c.parentElement?.tagName==="PRE")continue;const u=c.textContent??"",o=C(u,r);if(!o)continue;const l=document.createElement("span");l.classList.add("inline-widget");for(const p of o.clsNames)l.classList.add(p);l.style.setProperty("margin","0"),l.textContent=o.value;const f=document.createElement("span");f.appendChild(l),c.replaceWith(f)}})}const k="data-inline-code-css-live-marker";function D(i,t,e){for(const s of i.state.selection.ranges){const n=Math.min(s.from,s.to),r=Math.max(s.from,s.to);if(n<e&&r>t)return!0}return!1}function w(i){const t=i;return typeof t.button=="number"?t.button===0:!0}class b extends g.WidgetType{constructor(t,e,s,n,r){super(),this.clsNames=t,this.value=e,this.from=s,this.to=n,this.cursorPos=r}eq(t){if(this.value!==t.value||this.from!==t.from||this.to!==t.to||this.cursorPos!==t.cursorPos||this.clsNames.length!==t.clsNames.length)return!1;for(let e=0;e<this.clsNames.length;e++)if(this.clsNames[e]!==t.clsNames[e])return!1;return!0}enterEdit(t,e){this.cursorPos<=this.from||this.cursorPos>=this.to||(e.preventDefault(),e.stopPropagation(),typeof e.stopImmediatePropagation=="function"&&e.stopImmediatePropagation(),t.focus(),t.dispatch({selection:{anchor:this.cursorPos},scrollIntoView:!0}))}toDOM(t){const e=document.createElement("span"),s=document.createElement("span");s.classList.add("inline-widget");for(const n of this.clsNames)s.classList.add(n);return s.style.setProperty("margin","0"),s.textContent=this.value,s.setAttribute("data-inline-code-css","1"),e.appendChild(s),e.addEventListener("pointerdown",n=>{w(n)&&this.enterEdit(t,n)},!0),e.addEventListener("mousedown",n=>{n.button===0&&this.enterEdit(t,n)},!0),e.addEventListener("click",n=>{w(n)&&this.enterEdit(t,n)},!0),e}ignoreEvent(t){return t.type==="pointerdown"||t.type==="mousedown"||t.type==="click"||t.type==="touchstart"}}function y(i){const t=/(`+)([^\n]*?)\1/g,e=()=>{const s=i(),n=x(s?.prefixClass??[]);return new g.MatchDecorator({regexp:t,decoration:(r,a,c)=>{if(!a.state.field(d.editorLivePreviewField,!1)||n.length===0)return null;const o=r[1]??"",l=r[2]??"",f=C(l,n);if(!f)return null;const p=c,m=c+(r[0]?.length??0);if(D(a,p,m))return null;const v=p+o.length;return g.Decoration.replace({widget:new b(f.clsNames,f.value,p,m,v),inclusive:!1})}})};return g.ViewPlugin.fromClass(class{constructor(n){n.dom.setAttribute(k,"1"),this.decorator=e(),this.decorations=this.decorator.createDeco(n)}update(n){if(n.selectionSet){this.decorations=this.decorator.createDeco(n.view);return}(n.docChanged||n.viewportChanged)&&(this.decorations=this.decorator.updateDeco(n,this.decorations))}},{decorations:s=>s.decorations})}class V extends d.Plugin{constructor(){super(...arguments),this.settings=P,this.livePreviewCompartment=new E.Compartment}async onload(){await this.loadSettings(),A(this,()=>this.settings),this.registerEditorExtension(this.livePreviewCompartment.of(y(()=>this.settings))),this.addSettingTab(new N(this.app,this)),this.addCommand({id:"dev-self-reload",name:"Dev: self-reload",callback:async()=>{const t=this.manifest.id;window.setTimeout(async()=>{await this.app.plugins.enablePlugin(t)},0),await this.app.plugins.disablePlugin(t)}})}async loadSettings(){const t=await this.loadData();this.settings=L(t)}async saveSettings(){await this.saveData(this.settings),this.reconfigureAllMarkdownEditors()}reconfigureAllMarkdownEditors(){const t=y(()=>this.settings),e=this.app.workspace.getLeavesOfType("markdown");for(const s of e){const n=s.view;if(!(n instanceof d.MarkdownView))continue;const r=n.editor?.cm,a=r&&typeof r.dispatch=="function"?r:null;a&&a.dispatch({effects:this.livePreviewCompartment.reconfigure(t)})}}}module.exports=V;
//# sourceMappingURL=main.js.map
